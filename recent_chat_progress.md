 src/auth/dto                    |       0 |        0 |     100 |       0 |           

  login.dto.ts                   |       0 |      100 |     100 |       0 | 1-9       

  register.dto.ts                |       0 |        0 |     100 |       0 | 1-58      

  social-login.dto.ts            |       0 |      100 |     100 |       0 | 1-14      

 src/auth/guards                 |       0 |        0 |       0 |       0 |           

  jwt-auth.guard.ts              |       0 |      100 |     100 |       0 | 1-5       

  local-auth.guard.ts            |       0 |      100 |     100 |       0 | 1-5       

  permissions.guard.ts           |       0 |        0 |       0 |       0 | 1-135     

  roles.guard.ts                 |       0 |        0 |       0 |       0 | 1-37      

 src/auth/strategies             |       0 |        0 |       0 |       0 |           

  jwt.strategy.ts                |       0 |        0 |       0 |       0 | 1-17      

  local.strategy.ts              |       0 |        0 |       0 |       0 | 1-40      

 src/finance                     |       0 |        0 |       0 |       0 |           

  finance.controller.ts          |       0 |        0 |       0 |       0 | 1-218     

  finance.module.ts              |       0 |      100 |     100 |       0 | 1-27      

  finance.service.ts             |       0 |        0 |       0 |       0 | 1-2339    

 src/finance/dto                 |       0 |      100 |       0 |       0 |           

  create-spending.dto.ts         |       0 |      100 |       0 |       0 | 1-79      

 src/finance/schemas             |     100 |       75 |     100 |     100 |           

  finance.schema.ts              |     100 |       75 |     100 |     100 | 11-80     

 src/investments                 |       0 |        0 |       0 |       0 |           

  investments.controller.ts      |       0 |        0 |       0 |       0 | 1-62      

  investments.module.ts          |       0 |      100 |     100 |       0 | 1-17      

  investments.service.ts         |       0 |        0 |       0 |       0 | 1-334     

 src/legal                       |       0 |        0 |       0 |       0 |           

  legal.controller.ts            |       0 |        0 |       0 |       0 | 1-15      

  legal.module.ts                |       0 |      100 |     100 |       0 | 1-9       

  legal.service.ts               |       0 |      100 |       0 |       0 | 1-17      

 src/modifications               |      75 |    75.75 |   72.72 |   78.33 |           

  modifications.controller.ts    |       0 |        0 |       0 |       0 | 1-72      

  modifications.module.ts        |       0 |      100 |     100 |       0 | 1-23      

  modifications.service.ts       |   93.75 |    78.94 |     100 |   97.91 | 35,139    

 src/modifications/dto           |       0 |      100 |     100 |       0 |           

  create-modification.dto.ts     |       0 |      100 |     100 |       0 | 1         

  update-modification.dto.ts     |       0 |      100 |     100 |       0 | 1-4       

 src/modifications/entities      |       0 |      100 |     100 |       0 |           

  modification.entity.ts         |       0 |      100 |     100 |       0 | 1         

 src/modifications/schemas       |     100 |       75 |     100 |     100 |           

  modification-request.schema.ts |     100 |       75 |     100 |     100 | 11-59     

 src/notifications               |   13.79 |    26.08 |       0 |   11.76 |           

  notifications.controller.ts    |       0 |        0 |       0 |       0 | 1-35      

  notifications.module.ts        |       0 |      100 |     100 |       0 | 1-22      

  notifications.service.ts       |   23.52 |    31.57 |       0 |   19.35 | 12-135    

 src/notifications/schemas       |     100 |       75 |     100 |     100 |           

  notification.schema.ts         |     100 |       75 |     100 |     100 | 19        

 src/privacy                     |       0 |        0 |       0 |       0 |           

  privacy.interceptor.ts         |       0 |        0 |       0 |       0 | 1-122     

  privacy.module.ts              |       0 |      100 |     100 |       0 | 1-19      

  privacy.service.ts             |       0 |        0 |       0 |       0 | 1-55      

 src/projects                    |    1.64 |      3.7 |       0 |    1.52 |           

  project-analytics.service.ts   |       0 |        0 |       0 |       0 | 1-52      

  projects.controller.ts         |       0 |        0 |       0 |       0 | 1-159     

  projects.module.ts             |       0 |      100 |     100 |       0 | 1-37      

  projects.service.ts            |    1.86 |     3.97 |       0 |    1.72 | 38-1855   

 src/projects/dto                |       0 |      100 |     100 |       0 |           

  create-project.dto.ts          |       0 |      100 |     100 |       0 | 1-40      

  update-market-news-item.dto.ts |       0 |      100 |     100 |       0 | 1-32      

  update-market-price.dto.ts     |       0 |      100 |     100 |       0 | 1-36      

 src/projects/schemas            |     100 |    78.57 |     100 |     100 |           

  market-news-item.schema.ts     |     100 |      100 |     100 |     100 |           

  market-price.schema.ts         |     100 |      100 |     100 |     100 |           

  project.schema.ts              |     100 |    78.57 |     100 |     100 | 17-86     

 src/uploads                     |       0 |        0 |       0 |       0 |           

  uploads.controller.ts          |       0 |        0 |       0 |       0 | 1-44      

  uploads.module.ts              |       0 |      100 |     100 |       0 | 1-9       

 src/users                       |       0 |        0 |       0 |       0 |           

  users.controller.ts            |       0 |        0 |       0 |       0 | 1-212     

  users.module.ts                |       0 |      100 |       0 |       0 | 1-33      

  users.service.ts               |       0 |        0 |       0 |       0 | 1-338     

 src/users/schemas               |     100 |    61.11 |     100 |     100 |           

  user.schema.ts                 |     100 |    61.11 |     100 |     100 | 38-59     

---------------------------------|---------|----------|---------|---------|-------------------
Test Suites: 1 passed, 1 total
Tests:       13 passed, 13 total
Snapshots:   0 total
Time:        6.351 s
Ran all test suites matching src/modifications/modifications.service.spec.ts.
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> cd 'c:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend\src\finance'
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend\src\finance> Get-Content -Path finance.service.spec.ts -TotalCount 500 | Out-String | % { $_.TrimEnd() } > finance.service.spec.ts.tmp
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend\src\finance> # I'll just use replace_file_content to fix the end.
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend\src\finance> cd 'c:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend'
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> npm run test -- src/finance/finance.service.spec.ts > finance_test_output.txt 2>&1
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> cd 'c:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend'
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> Get-Content -Path finance_test_output.txt -Encoding UTF8
node.exe : npm warn using --force Recommended protections disabled.
At C:\Users\Hassa\AppData\Roaming\npm\npm.ps1:24 char:5
+     & "node$exe"  "$basedir/node_modules/npm/bin/npm-cli.js" $args
+     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (npm warn using ...tions disabled.:Strin  
   g) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError


> backend@0.0.1 test
> jest src/finance/finance.service.spec.ts

  console.warn
    [approvals-debug] {
      spendingId: new ObjectId('699bff34ecb77b2e344f8d03'),
      eligibleInvestorIds: [ '699bff34ecb77b2e344f8cf9', '699bff34ecb77b2e344f8cf7' ],
      approvalKeys: [ '699bff34ecb77b2e344f8cf7' ],
      approvedBy: [],
      waitingFor: [
        { id: '699bff34ecb77b2e344f8cf9', name: null },
        { id: '699bff34ecb77b2e344f8cf7', name: 'Unknown' }
      ],
      sampleApproval: {
        status: 'rejected',
        user: '699bff34ecb77b2e344f8cf7',
        userName: 'Unknown',
        date: 2026-02-23T07:18:12.249Z
      }
    }

      339 |     if (!mismatch) return;
      340 |
    > 341 |     console.warn('[approvals-debug]', {
          |             ^
      342 |       spendingId: spending?._id || spending?.id,
      343 |       eligibleInvestorIds,
      344 |       approvalKeys: Object.keys(enrichedApprovals),

      at FinanceService.logApprovalMismatchIfNeeded (finance/finance.service.ts:341:13)
      at FinanceService.enrichSpendingForResponse (finance/finance.service.ts:421:10) 
      at FinanceService.buildSpendingResponse (finance/finance.service.ts:560:17)     

FAIL src/finance/finance.service.spec.ts
  FinanceService
    ΓêÜ should be defined (14 ms)
    Utility Helpers
      ΓêÜ getId resolves strings, objects, and objectids (4 ms)
      ΓêÜ isPrivilegedRole identifies admin roles (8 ms)
      ΓêÜ parseStatusFilter handles varied inputs (3 ms)
    addSpending
      ΓêÜ throws NotFoundException if project not found (5 ms)
      ΓêÜ successfully creates spending and notifies investors (7 ms)
      ΓêÜ enforces positive spending amount (3 ms)
      ΓêÜ throws error if spending exceeds project capacity (3 ms)
    voteSpending
      ΓêÜ throws BadRequestException if already finalized (3 ms)
      ΓêÜ records an approval vote and finalizes if threshold reached (3 ms)
      ΓêÜ records a rejection and finalizes immediately (52 ms)
      ΓêÜ throws ForbiddenException if user is not an active investor (2 ms)
    findAll
      ΓêÜ returns all spendings for a project with enrichment (3 ms)
      ΓêÜ filters spendings by status (2 ms)
    searchSpendings
      ├ù performs paginated search (2 ms)
    Ledgers
      ├ù creates a ledger (1 ms)
      ├ù findAllLedgers returns ledgers for project (1 ms)
      ├ù findOneLedger returns single ledger (1 ms)
      ├ù updateLedger updates ledger (2 ms)
      ├ù deleteLedger deletes ledger (4 ms)
    Analytics & Summary
      ΓêÜ getExpenseAnalytics returns formatted analytics (3 ms)
      ├ù getSpendingSummary returns totals (1 ms)
      ├ù getBulkSpendingSummary returns multiple summaries (3 ms)
    exportExpenses extension
      ΓêÜ handles different formats and filters (57 ms)

  ΓùÅ FinanceService ΓÇ║ searchSpendings ΓÇ║ performs paginated search

    ForbiddenException: You do not have access to this project

      581 |     );
      582 |     if (!isCreator &&
!isInvestor) {
    > 583 |       throw new
ForbiddenException('You do not have access to this
project');
          |             ^
      584 |     }
      585 |
      586 |     return project;

      at FinanceService.assertProjectAccess (finance/finance.service.ts:583:13)       
      at FinanceService.searchSpendings (finance/finance.service.ts:1432:21)
      at Object.<anonymous> (finance/finance.service.spec.ts:239:22)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ creates a ledger

    TypeError: this.ledgerModel is not a constructor

      1512 |   async createLedger(createLedgerDto:
any, user: any) {
      1513 |     await this.assertProjectWrit
eAccess(createLedgerDto?.project, user);
    > 1514 |     const ledger =
new this.ledgerModel(createLedgerDto);
           |                    ^
      1515 |     return ledger.save();
      1516 |   }
      1517 |

      at FinanceService.createLedger (finance/finance.service.ts:1514:20)
      at Object.<anonymous> (finance/finance.service.spec.ts:255:19)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ findAllLedgers returns ledgers for project       

    NotFoundException: Project not found

      570 |   ):
Promise<any> {
      571 |     const project = await
this.projectsService.findOne(projectId);
    > 572 |     if (!project)
throw new NotFoundException('Project not
found');
          |                         ^
      573 |
      574 |     if
(this.isPrivilegedRole(user?.role))
return project;
      575 |

      at FinanceService.assertProjectAccess (finance/finance.service.ts:572:25)       
      at FinanceService.findAllLedgers (finance/finance.service.ts:1520:7)
      at Object.<anonymous> (finance/finance.service.spec.ts:261:19)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ findOneLedger returns single ledger

    NotFoundException: Project not found

      570 |   ):
Promise<any> {
      571 |     const project = await
this.projectsService.findOne(projectId);
    > 572 |     if (!project)
throw new NotFoundException('Project not
found');
          |                         ^
      573 |
      574 |     if
(this.isPrivilegedRole(user?.role))
return project;
      575 |

      at FinanceService.assertProjectAccess (finance/finance.service.ts:572:25)       
      at FinanceService.findOneLedger (finance/finance.service.ts:1540:5)
      at Object.<anonymous> (finance/finance.service.spec.ts:267:19)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ updateLedger updates ledger

    NotFoundException: Project not found

      570 |   ):
Promise<any> {
      571 |     const project = await
this.projectsService.findOne(projectId);
    > 572 |     if (!project)
throw new NotFoundException('Project not
found');
          |                         ^
      573 |
      574 |     if
(this.isPrivilegedRole(user?.role))
return project;
      575 |

      at FinanceService.assertProjectAccess (finance/finance.service.ts:572:25)       
      at FinanceService.assertProjectWriteAccess (finance/finance.service.ts:593:21)  
      at FinanceService.updateLedger (finance/finance.service.ts:1555:5)
      at Object.<anonymous> (finance/finance.service.spec.ts:273:19)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ deleteLedger deletes ledger

    NotFoundException: Project not found

      570 |   ):
Promise<any> {
      571 |     const project = await
this.projectsService.findOne(projectId);
    > 572 |     if (!project)
throw new NotFoundException('Project not
found');
          |                         ^
      573 |
      574 |     if
(this.isPrivilegedRole(user?.role))
return project;
      575 |

      at FinanceService.assertProjectAccess (finance/finance.service.ts:572:25)       
      at FinanceService.assertProjectWriteAccess (finance/finance.service.ts:593:21)  
      at FinanceService.deleteLedger (finance/finance.service.ts:1567:5)
      at Object.<anonymous> (finance/finance.service.spec.ts:279:19)

  ΓùÅ FinanceService ΓÇ║ Analytics & Summary ΓÇ║ getSpendingSummary returns totals    

    ForbiddenException: You do not have access to this project

      581 |     );
      582 |     if (!isCreator &&
!isInvestor) {
    > 583 |       throw new
ForbiddenException('You do not have access to this
project');
          |             ^
      584 |     }
      585 |
      586 |     return project;

      at FinanceService.assertProjectAccess (finance/finance.service.ts:583:13)       
      at FinanceService.getSpendingSummary (finance/finance.service.ts:1787:21)       
      at Object.<anonymous> (finance/finance.service.spec.ts:301:19)

  ΓùÅ FinanceService ΓÇ║ Analytics & Summary ΓÇ║ getBulkSpendingSummary returns       
multiple summaries

    TypeError: expect(received).toHaveLength(expected)

    Matcher error: received value must have a length property whose value must be a   
number

    Received has type:  object
    Received has value: {"summaries": []}

      307 |
spendingModel.find.mockReturnValue(mockQuery([{
project: p1, amount: 100,
status: 'approved' }]));
      308 |       const res = await
service.getBulkSpendingSummary([p1.toHexString()],
mockUser);
    > 309 |
expect(res).toHaveLength(1);
          |                   ^
      310 |     });
      311 |   });
      312 |

      at Object.<anonymous> (finance/finance.service.spec.ts:309:19)

Test Suites: 1 failed, 1 total
Tests:       8 failed, 16 passed, 24 total
Snapshots:   0 total
Time:        2.63 s, estimated 5 s
Ran all test suites matching src/finance/finance.service.spec.ts.
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> ^C
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> cd 'c:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend'
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> npm run test -- src/finance/finance.service.spec.ts > finance_test_output.txt 2>&1
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> ^C
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> cd 'c:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend'
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> ^C
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> Get-Content -Path finance_test_output.txt -Encoding UTF8
node.exe : npm warn using --force Recommended protections disabled.
At C:\Users\Hassa\AppData\Roaming\npm\npm.ps1:24 char:5
+     & "node$exe"  "$basedir/node_modules/npm/bin/npm-cli.js" $args
+     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (npm warn using ...tions disabled.:Strin  
   g) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 

> backend@0.0.1 test
> jest src/finance/finance.service.spec.ts

  console.warn
    [approvals-debug] {
      spendingId: new ObjectId('699bffe331a3383e1b57ed78'),
      eligibleInvestorIds: [ '699bffe331a3383e1b57ed6e', '699bffe331a3383e1b57ed6c' ],
      approvalKeys: [ '699bffe331a3383e1b57ed6c' ],
      approvedBy: [],
      waitingFor: [
        { id: '699bffe331a3383e1b57ed6e', name: null },
        { id: '699bffe331a3383e1b57ed6c', name: 'Unknown' }
      ],
      sampleApproval: {
        status: 'rejected',
        user: '699bffe331a3383e1b57ed6c',
        userName: 'Unknown',
        date: 2026-02-23T07:21:07.515Z
      }
    }

      339 |     if (!mismatch) return;
      340 |
    > 341 |     console.warn('[approvals-debug]', {
          |             ^
      342 |       spendingId: spending?._id || spending?.id,
      343 |       eligibleInvestorIds,
      344 |       approvalKeys: Object.keys(enrichedApprovals),

      at FinanceService.logApprovalMismatchIfNeeded (finance/finance.service.ts:341:13)
      at FinanceService.enrichSpendingForResponse (finance/finance.service.ts:421:10) 
      at FinanceService.buildSpendingResponse (finance/finance.service.ts:560:17)     

FAIL src/finance/finance.service.spec.ts
  FinanceService
    ΓêÜ should be defined (20 ms)
    Utility Helpers
      ΓêÜ getId resolves strings, objects, and objectids (6 ms)
      ΓêÜ isPrivilegedRole identifies admin roles (9 ms)
      ΓêÜ parseStatusFilter handles varied inputs (3 ms)
    addSpending
      ΓêÜ throws NotFoundException if project not found (5 ms)
      ΓêÜ successfully creates spending and notifies investors (8 ms)
      ΓêÜ enforces positive spending amount (4 ms)
      ΓêÜ throws error if spending exceeds project capacity (4 ms)
    voteSpending
      ΓêÜ throws BadRequestException if already finalized (5 ms)
      ΓêÜ records an approval vote and finalizes if threshold reached (4 ms)
      ΓêÜ records a rejection and finalizes immediately (58 ms)
      ΓêÜ throws ForbiddenException if user is not an active investor (3 ms)
    findAll
      ΓêÜ returns all spendings for a project with enrichment (3 ms)
      ΓêÜ filters spendings by status (2 ms)
    searchSpendings
      ├ù performs paginated search (3 ms)
    Ledgers
      ├ù creates a ledger (2 ms)
      ├ù findAllLedgers returns ledgers for project (2 ms)
      ΓêÜ findOneLedger returns single ledger (2 ms)
      ├ù updateLedger updates ledger (4 ms)
      ΓêÜ deleteLedger deletes ledger (4 ms)
    Analytics & Summary
      ΓêÜ getExpenseAnalytics returns formatted analytics (3 ms)
      ├ù getSpendingSummary returns totals (3 ms)
      ΓêÜ getBulkSpendingSummary returns multiple summaries (3 ms)
    exportExpenses extension
      ΓêÜ handles different formats and filters (53 ms)

  ΓùÅ FinanceService ΓÇ║ searchSpendings ΓÇ║ performs paginated search

    TypeError: this.spendingModel.find(...).populate(...).populate(...).populate(...) 
.sort(...).skip is not a function

      1479 |         .populate('ledger',
'name subLedgers')
      1480 |         .sort({ createdAt:
-1 })
    > 1481 |         .skip(skip)
           |          ^
      1482 |         .limit(limit)
      1483 |         .exec(),
      1484 |       this.spendingModel.countDo
cuments(query).exec(),

      at FinanceService.searchSpendings (finance/finance.service.ts:1481:10)
      at Object.<anonymous> (finance/finance.service.spec.ts:240:22)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ creates a ledger

    TypeError: this.ledgerModel is not a constructor

      1512 |   async createLedger(createLedgerDto:
any, user: any) {
      1513 |     await this.assertProjectWrit
eAccess(createLedgerDto?.project, user);
    > 1514 |     const ledger =
new this.ledgerModel(createLedgerDto);
           |                    ^
      1515 |     return ledger.save();
      1516 |   }
      1517 |

      at FinanceService.createLedger (finance/finance.service.ts:1514:20)
      at Object.<anonymous> (finance/finance.service.spec.ts:260:19)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ findAllLedgers returns ledgers for project       

    BSONError: input must be a 24 character hex string, 12 byte Uint8Array, or an     
integer

      1520 |       await
this.assertProjectAccess(projectId, user);
      1521 |       return this.ledgerModel
    > 1522 |         .find({
project: new
Types.ObjectId(projectId) as any })
           |                          ^
      1523 |         .exec();
      1524 |     }
      1525 |

      at new ObjectId (../node_modules/bson/src/objectid.ts:113:15)
      at FinanceService.findAllLedgers (finance/finance.service.ts:1522:26)
      at Object.<anonymous> (finance/finance.service.spec.ts:266:19)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ updateLedger updates ledger

    TypeError: this.ledgerModel.findByIdAndUpdate is not a function

      1556 |
      1557 |     const ledger = await
this.ledgerModel
    > 1558 |
.findByIdAndUpdate(id, updateDto, {
returnDocument: 'after' })
           |        ^
      1559 |       .exec();
      1560 |     if (!ledger) throw
new NotFoundException('Ledger not found');
      1561 |     return ledger;

      at FinanceService.updateLedger (finance/finance.service.ts:1558:8)
      at Object.<anonymous> (finance/finance.service.spec.ts:278:19)

  ΓùÅ FinanceService ΓÇ║ Analytics & Summary ΓÇ║ getSpendingSummary returns totals    

    ForbiddenException: You do not have access to this project

      581 |     );
      582 |     if (!isCreator &&
!isInvestor) {
    > 583 |       throw new
ForbiddenException('You do not have access to this
project');
          |             ^
      584 |     }
      585 |
      586 |     return project;

      at FinanceService.assertProjectAccess (finance/finance.service.ts:583:13)       
      at FinanceService.getSpendingSummary (finance/finance.service.ts:1787:21)       
      at Object.<anonymous> (finance/finance.service.spec.ts:307:19)

Test Suites: 1 failed, 1 total
Tests:       5 failed, 19 passed, 24 total
Snapshots:   0 total
Time:        2.509 s, estimated 3 s
Ran all test suites matching src/finance/finance.service.spec.ts.
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> ^C
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> cd 'c:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend'
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> npm run test -- src/finance/finance.service.spec.ts > finance_test_output.txt 2>&1
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> cd 'c:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend'
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> Get-Content -Path finance_test_output.txt -Encoding UTF8
node.exe : npm warn using --force Recommended protections disabled.
At C:\Users\Hassa\AppData\Roaming\npm\npm.ps1:24 char:5
+     & "node$exe"  "$basedir/node_modules/npm/bin/npm-cli.js" $args
+     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (npm warn using ...tions disabled.:Strin  
   g) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError


> backend@0.0.1 test
> jest src/finance/finance.service.spec.ts

  console.warn
    [approvals-debug] {
      spendingId: new ObjectId('699c004cba1fd982ddc5ca93'),
      eligibleInvestorIds: [ '699c004cba1fd982ddc5ca88', '699c004cba1fd982ddc5ca86' ],
      approvalKeys: [ '699c004cba1fd982ddc5ca86' ],
      approvedBy: [],
      waitingFor: [
        { id: '699c004cba1fd982ddc5ca88', name: null },
        { id: '699c004cba1fd982ddc5ca86', name: 'Unknown' }
      ],
      sampleApproval: {
        status: 'rejected',
        user: '699c004cba1fd982ddc5ca86',
        userName: 'Unknown',
        date: 2026-02-23T07:22:52.644Z
      }
    }

      339 |     if (!mismatch) return;
      340 |
    > 341 |     console.warn('[approvals-debug]', {
          |             ^
      342 |       spendingId: spending?._id || spending?.id,
      343 |       eligibleInvestorIds,
      344 |       approvalKeys: Object.keys(enrichedApprovals),

      at FinanceService.logApprovalMismatchIfNeeded (finance/finance.service.ts:341:13)
      at FinanceService.enrichSpendingForResponse (finance/finance.service.ts:421:10) 
      at FinanceService.buildSpendingResponse (finance/finance.service.ts:560:17)     

FAIL src/finance/finance.service.spec.ts
  FinanceService
    ΓêÜ should be defined (15 ms)
    Utility Helpers
      ΓêÜ getId resolves strings, objects, and objectids (6 ms)
      ΓêÜ isPrivilegedRole identifies admin roles (11 ms)
      ΓêÜ parseStatusFilter handles varied inputs (4 ms)
    addSpending
      ΓêÜ throws NotFoundException if project not found (5 ms)
      ΓêÜ successfully creates spending and notifies investors (8 ms)
      ΓêÜ enforces positive spending amount (3 ms)
      ΓêÜ throws error if spending exceeds project capacity (4 ms)
    voteSpending
      ΓêÜ throws BadRequestException if already finalized (4 ms)
      ΓêÜ records an approval vote and finalizes if threshold reached (3 ms)
      ΓêÜ records a rejection and finalizes immediately (54 ms)
      ΓêÜ throws ForbiddenException if user is not an active investor (2 ms)
    findAll
      ΓêÜ returns all spendings for a project with enrichment (2 ms)
      ΓêÜ filters spendings by status (2 ms)
    searchSpendings
      ├ù performs paginated search (2 ms)
    Ledgers
      ├ù creates a ledger (1 ms)
      ΓêÜ findAllLedgers returns ledgers for project (2 ms)
      ΓêÜ findOneLedger returns single ledger (1 ms)
      ΓêÜ updateLedger updates ledger (1 ms)
      ΓêÜ deleteLedger deletes ledger (4 ms)
    Analytics & Summary
      ΓêÜ getExpenseAnalytics returns formatted analytics (2 ms)
      ├ù getSpendingSummary returns totals (4 ms)
      ΓêÜ getBulkSpendingSummary returns multiple summaries (2 ms)
    exportExpenses extension
      ΓêÜ handles different formats and filters (50 ms)

  ΓùÅ FinanceService ΓÇ║ searchSpendings ΓÇ║ performs paginated search

    TypeError: this.spendingModel.find(...).populate(...).populate(...).populate(...) 
.sort(...).skip is not a function

      1479 |         .populate('ledger',
'name subLedgers')
      1480 |         .sort({ createdAt:
-1 })
    > 1481 |         .skip(skip)
           |          ^
      1482 |         .limit(limit)
      1483 |         .exec(),
      1484 |       this.spendingModel.countDo
cuments(query).exec(),

      at FinanceService.searchSpendings (finance/finance.service.ts:1481:10)
      at Object.<anonymous> (finance/finance.service.spec.ts:242:22)

  ΓùÅ FinanceService ΓÇ║ Ledgers ΓÇ║ creates a ledger

    TypeError: this.ledgerModel is not a constructor

      1512 |   async createLedger(createLedgerDto:
any, user: any) {
      1513 |     await this.assertProjectWrit
eAccess(createLedgerDto?.project, user);
    > 1514 |     const ledger =
new this.ledgerModel(createLedgerDto);
           |                    ^
      1515 |     return ledger.save();
      1516 |   }
      1517 |

      at FinanceService.createLedger (finance/finance.service.ts:1514:20)
      at Object.<anonymous> (finance/finance.service.spec.ts:263:19)

  ΓùÅ FinanceService ΓÇ║ Analytics & Summary ΓÇ║ getSpendingSummary returns totals    

    expect(received).toBe(expected) // Object.is equality

    Expected: 50
    Received: undefined

      311 |
spendingModel.find.mockReturnValue(mockQuery([{
amount: 50, status: 'approved'
}]));
      312 |       const res = await
service.getSpendingSummary(pid.toHexString(), {
...mockUser, role: 'admin' });
    > 313 |
expect(res.totalApproved).toBe(50);
          |                                 ^
      314 |     });
      315 |        
    expect(received).toBe(expected) // Object.is equality

    Expected: 50
    Received: undefined

      311 |
spendingModel.find.mockReturnValue(mockQuery([{
amount: 50, status: 'approved'
}]));
      312 |       const res = await
service.getSpendingSummary(pid.toHexString(), {
...mockUser, role: 'admin' });
    > 313 |
expect(res.totalApproved).toBe(50);
          |                                 ^
      314 |     });
      315 |
...mockUser, role: 'admin' });
    > 313 |
expect(res.totalApproved).toBe(50);
          |                                 ^
      314 |     });
      315 |
      316 |     it('getBulkSpendingSummary returns multiple
summaries', async () => {

      at Object.<anonymous> (finance/finance.service.spec.ts:313:33)
      316 |     it('getBulkSpendingSummary returns multiple
summaries', async () => {

      316 |     it('getBulkSpendingSummary returns multiple
summaries', async () => {

      at Object.<anonymous> (finance/finance.service.spec.ts:313:33)      

Test Suites: 1 failed, 1 total
Tests:       3 failed, 21 passed, 24 total
Snapshots:   0 total
Time:        2.251 s, estimated 3 s
Ran all test suites matching src/finance/finance.service.spec.ts.
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_pr^C\backend>
PS C:\Users\Hassa\Documents\Magnus_Copo_documents\Magnus_Copo_Workspace_Files\Split_flow_final_prod\backend> 